$(function(){var e=Settings.getValue("ver");"2.0"!=e&&(Settings.setValue("ver","2.0"),chrome.tabs.create({url:"options.html"}));var t={},n=new backgroundConnector,i=null;t.list=null,t.listCount=0,t.listPage=1,t.songs=new Array,t.index=0,t.type=Settings.getValue("type","list"),t.error=0,t.fav="0",t.errorTime=new Date,t.options=function(){return Settings.getObject("options")||{list:1,radio:1,rank:1,mine:1,lyric:1,notify:1,cover:"album"}},t.init=function(){$("body").append("<audio id='player' autoplay></audio>"),i=document.getElementById("player"),i.volume=Settings.getValue("volume",1),i.addEventListener("error",function(){t.errorTime=new Date;var e=new Date-t.errorTime;e>6e4&&(t.error=0),t.error<100&&t.playNext(),t.error++}),i.addEventListener("timeupdate",function(){var e=Math.round(i.currentTime/i.duration*100),t={act:"timeupdate",time:i.currentTime,percent:e,duration:i.duration};n.send(t)}),i.addEventListener("ended",function(){t.playNext()}),t.listCount=parseInt(Settings.getValue("count","0")),t.index=parseInt(Settings.getValue("index","0")),t.listPage=parseInt(Settings.getValue("page","1"));var e=Settings.getObject("list");e&&(t.list=e);var s=Settings.getObject("songs");s&&(t.songs=s)},t.getAndPlay=function(e){switch(n.send({act:"loading"}),t.type){case"dj":t.getAndPlayDj();break;case"singer":t.getAndPlayRadio(!0);break;case"album":t.getAndPlayAlbum();break;default:t.getAndPlayList(e)}},t.getAndPlayList=function(e){t.index=0,e&&(t.index=e),t.listPage=1,Settings.setValue("page",t.listPage),Settings.setValue("type","list"),Settings.setObject("list",t.list);var n=t.list.id,i="http://music.163.com/api/playlist/detail?id="+n;i+="&csrf_token="+Settings.getValue("lckey",""),$.get(i,function(e){if(200==e.code){if(t.listCount=e.result.trackCount,Settings.setValue("count",t.listCount),t.songs=e.result.tracks,"1"==t.fav)for(var n=0;n<t.songs.length;n++)t.songs[n].isfaved="1";Settings.setObject("songs",t.songs),t.play()}})},t.getAndPlayAlbum=function(){t.index=0,t.listPage=1,Settings.setValue("page",t.listPage),Settings.setValue("type","album");var e=(new Date).getTime(),n={};n.id=t.list.id,n.coverurl=t.list.cover,n.name=t.list.name,t.list.artists.length>0&&(n.creator={nick_name:t.list.artists[0].name,portrait:t.list.artists[0].portrait}),Settings.setObject("list",n);var i=t.list.id,s=Settings.getValue("lckey",""),a="http://v5.pc.duomi.com/singer-ajaxsinger-albumsongs?id="+i+"&pi=1&pz=50&_="+e+"&lckey="+s;$.getJSON(a,function(e){if(0==e.dm_error){t.listCount=e.total,Settings.setValue("count",t.listCount);for(var n=new Array,i=0;i<e.tracks.length;i++)n.push({track:e.tracks[i],album:e.tracks[i].album});t.songs=n,Settings.setObject("songs",t.songs),t.play()}})},t.getAndPlayDj=function(e){t.index=0,e&&(t.index=e),t.listPage=1,Settings.setValue("page",t.listPage);var n=((new Date).getTime(),t.list.id),i="http://music.163.com/api/dj/program/detail?id="+n+"&ids=%5B"+n+"%5D";i+="&csrf_token="+Settings.getValue("lckey",""),$.getJSON(i,function(e){e.program&&e.program.songs&&e.program.songs.length>0&&(t.songs=e.program.songs,t.listCount=e.program.songs.length,Settings.setValue("count",t.listCount),Settings.setObject("songs",t.songs),e.program.songs=null,t.list=e.program,Settings.setObject("list",t.list),t.playDj())})},t.getAndPlayRadio=function(e){t.index=0,t.listPage=1,Settings.setValue("page",t.listPage);var n=((new Date).getTime(),t.list.id),i="http://search.pc.duomi.com/search?t=getrndlistsong&plid="+n+"&pi=50&mz",s={};s.id=t.list.id,s.creator={nick_name:"网易云音乐",portrait:"img/logo.png"},e?(i="http://v5.pc.duomi.com/singer-ajaxsinger-radio?id="+n,s.coverurl=t.list.portrait,s.name=t.list.name+"电台",Settings.setValue("type","singer")):(Settings.setValue("type","radio"),s.coverurl=t.list.treenode.url,s.name=t.list.treenode.name),Settings.setObject("list",s),$.getJSON(i,function(e){if(e.item){t.listCount=e.head.hit,Settings.setValue("count",t.listCount),t.songs=new Array;for(var n=0;n<e.item.length;n++){var i=e.item[n],s={};s.id=i.sid,s.name=i.sname,s.singer=i.sartist,s.pic=""!=i.alid?"http://imgv5.duomiyy.com/album/l"+i.alid+".jpg":"img/cover.png",t.songs.push(s)}Settings.setObject("songs",t.songs),t.playRadio()}})},t.playPrev=function(){t.pause(),t.index-=1,t.play()},t.playNext=function(){t.index+=1,t.play()},t.volumeUp=function(){var e=document.getElementById("player");e.volume+.1<=1?e.volume+=.1:e.volume=1,Settings.setValue("volume",e.volume.toFixed(2))},t.volumeDown=function(){var e=document.getElementById("player");e.volume-.1>0?e.volume-=.1:e.volume=0,Settings.setValue("volume",e.volume.toFixed(2))},t.pause=function(){i.pause()},t.replay=function(){i.currentTime>0?i.play():(i.src="",t.play())},t.play=function(){1==Settings.getValue("cycle",0)?i.currentTime>0?i.play():(i.src="","radio"==t.type||"singer"==t.type?t.playRadio():t.playTo()):2==Settings.getValue("cycle",0)?"radio"==t.type||"singer"==t.type?t.playRadio():t.playRandom():"radio"==t.type||"singer"==t.type?t.playRadio():t.playTo()},t.playTo=function(){if(t.index<0&&(t.index=0),t.index>=t.listCount)t.index=0;else{var e=t.songs[t.index];Settings.setObject("song",e),Settings.setValue("index",t.index),n.send({act:"play"}),i.setAttribute("src",e.mp3Url),i.play(),n.send({act:"loaded"})}if(1==t.options().notify){var s=new notify;s.show()}},t.playRandom=function(){if(t.index<0&&(t.index=0),t.index>=t.listCount)t.index=0;else{var e=t.songs[Math.floor(Math.random()*t.index+1)];Settings.setObject("song",e),Settings.setValue("index",t.index),n.send({act:"play"}),i.setAttribute("src",e.mp3Url),i.play(),n.send({act:"loaded"})}if(1==t.options().notify){var s=new notify;s.show()}},t.playDj=function(){if(t.index<0&&(t.index=0),t.index>=t.listCount)t.getAndPlayDj();else{var e=t.songs[t.index];Settings.setObject("song",e),Settings.setValue("index",t.index),n.send({act:"play"}),i.setAttribute("src",e.mp3Url),i.play(),n.send({act:"loaded"})}if(1==t.options().notify){var s=new notify;s.show()}},t.playRadio=function(){if(t.index<0&&(t.index=0),t.index>=t.listCount)t.getAndPlayRadio();else{var e=t.songs[t.index];Settings.setObject("song",e),Settings.setValue("index",t.index),n.send({act:"play"}),i.setAttribute("src",t.url(e.id)),i.load(),n.send({act:"loaded"})}if(1==t.options().notify){var s=new notify;s.show()}},t.url=function(e){return"http://www.duomi.com/third-getfile?id="+e},window.notify=function(){var e,t=!1,n=null;return{show:function(){if(window.webkitNotifications){var n=Settings.getObject("song"),i="",s=n.artists[0].name,a=n.name,o="";o="<"+n.album.name+"> ",i=n.album.picUrl+"?param=60y60";var r=o+a;e=webkitNotifications.createNotification(i,s,r),e.show(),t=!0,this.timer()}},hide:function(){e.cancel(),t=!1},timer:function(){n=setTimeout(function(){this.hide(),n=null}.bind(this),3e3)},clear:function(){clearTimeout(n),n=null},isVisible:function(){return t}}};var s={};s.init=function(){n.name="163music",n.onConnect=function(){},n.onDisConnect=function(){},n.init(function(e){switch(e.act){case"playlist":t.list=e.data,t.type="list",t.fav=e.fav,t.songs=new Array,t.getAndPlay(e.idx);break;case"playdj":t.list=e.data,t.songs=new Array,t.type="dj",t.getAndPlayDj(e.idx);break;case"playradio":t.list=e.data,t.songs=new Array,t.type="radio",t.getAndPlay();break;case"playalbum":t.list=e.data,t.type="album",t.songs=new Array,t.getAndPlay();break;case"playsinger":t.list=e.data,t.type="singer",t.songs=new Array,t.getAndPlay();break;case"pause":t.pause();break;case"play":t.replay();break;case"next":t.playNext();break;case"prev":t.playPrev();break;case"up":t.volumeUp();break;case"down":t.volumeDown()}}),t.init()},s.init()}),chrome.webRequest.onBeforeSendHeaders.addListener(function(e){if("xmlhttprequest"===e.type||"other"===e.type){for(var t=!1,n=0;n<e.requestHeaders.length;++n)if("Referer"===e.requestHeaders[n].name){t=!0,e.requestHeaders[n].value="http://music.163.com";break}return t||e.requestHeaders.push({name:"Referer",value:"http://music.163.com"}),{requestHeaders:e.requestHeaders}}},{urls:["http://music.163.com/api/*","http://*.music.126.net/*"]},["blocking","requestHeaders"]);