$(function(){var e={};e.lckey="",e.domain="http://music.163.com",e.loaded={list:!1,listType:"hot",loadingMore:null,rank:!1,radio:!1,singer:!1,singerKey:"",page:1,pageCount:20,songCount:1,userInfo:null,loadingTimer:null,uid:null,hasMore:!0,playing:!1},e.lyric=null,e.options=Settings.getObject("options")||{list:1,radio:1,rank:1,mine:1,lyric:1,notify:1,cover:"album"},e.options.lyric||(e.options.lyric=1);var a=new mainConnector;e.init=function(){chrome.cookies.get({url:e.domain,name:"__csrf"},function(a){null!=a&&(e.lckey=a.value),Settings.setValue("lckey",e.lckey)}),e.loaded.userInfo=Settings.getObject("userInfo"),a.name="163music",a.init(),a.onMessage(function(a){switch(a.act){case"play":e.player.info();break;case"loading":e.loading();break;case"loaded":e.loading(!0);break;case"timeupdate":e.loaded.playing||(e.loaded.playing=!0,$(".cd img").hasClass("pausing")&&$(".cd img").removeClass("pausing"),$(".cd .ctrl").hasClass("play")&&$(".cd .ctrl").removeClass("play").addClass("pause")),e.player.timing(a)}});var t=e.options;0==t.rank&&$("nav ul li").eq(1).hide(),0==t.radio&&$("nav ul li").eq(2).hide(),0==t.mine&&$("nav ul li").eq(3).hide(),e.bind(),e.player.info(),void 0==Settings.getObject("song")&&$(".footer").trigger("click")},e.nav=function(){e.nav.scroll(!0)},e.nav.scroll=function(a){a?($(".list").unbind("scroll"),$(".list").bind("scroll",function(){var a=$(".list").scrollTop();e.loaded.loadingMore||e.loaded.hasMore&&$(".list ul:visible").height()-a<300&&(e.loaded.page++,e.loaded.loadingMore=!0,"dj"==e.loaded.listType?e.dj(e.loaded.page,e.loaded.pageCount,!0):e.list(e.loaded.listType,e.loaded.page,e.loaded.pageCount,!0))})):$(".list").unbind("scroll")},e.bind=function(){e.nav(),$(".footer").bind("click",function(){$(".body").animate({top:0}),$(this).hide(),setTimeout(function(){$(".header").addClass("up"),$("nav div input").show()},300),e.loaded.list||e.list("hot",1,20)}),$(".arrow").bind("click",function(){$("nav div input").hide(),$(".body").animate({top:"285px"}),$("footer").show(),$("header").removeClass("up")}),$("nav ul li").bind("click",function(){var a=$(this);$("nav ul li").removeClass("hover"),a.addClass("hover");var t=a.text();switch(t){case"分类":e.rank(),e.nav.scroll(!1);break;case"最热":e.list("hot",1,20),e.nav.scroll(!0);break;case"最新":e.list("new",1,20),e.nav.scroll(!0);break;case"DJ":e.dj(1,20),e.nav.scroll(!0);break;case"收藏":e.user(!0),e.nav.scroll(!1);break;default:e.search(),e.nav.scroll(!1)}}),$(".search button").bind("click",function(){var a=$("#keyword").val();""!=a&&e.list("search",0,100,!1,a)}),$("nav input").bind("keydown",function(){if(13==event.keyCode){$("nav ul li").removeClass("hover"),e.nav.scroll(!1);var a=$(this).val();e.singer(a)}}),$(".list").on("mouseover","li p",function(){var e=$(this);$("."+e.attr("class")).siblings(".loc").hide(),$("."+e.attr("class")).siblings(".intro").hide(),e.siblings(".loc").show(),e.siblings(".intro").show()}),$(".list").on("click","p a",function(){var a=$(this);e.player.playlist(a.attr("data-id"),a.attr("data-type"),a.attr("data-fav")),setTimeout(function(){$(".arrow").trigger("click")},200)}),$(".rank").on("click","li a",function(){var a=$(this);e.list(a.text(),1,20),e.nav.scroll(!0)}),$(".cd .ctrl").bind("click",function(){var a=$(this);a.hasClass("pause")?e.player.pause():e.player.play()}),$(".player").bind("mouseover",function(){$(".info").show(),parseInt(Settings.getValue("index",0))>0&&$(".prev").show(),1!=e.loaded.songCount&&$(".next").show(),$("#favBtn").show()}),$("#favBtn").bind("click",function(){e.fav()}),$(".player").bind("mouseout",function(){$(".next,.prev,.info,#favBtn").hide()}),$(".next").bind("click",function(){e.player.reset(),e.player.next()}),$(".prev").bind("click",function(){e.player.reset(),e.player.prev()}),1==Settings.getValue("cycle",0)?$(".cycle").addClass("cycle1"):2==Settings.getValue("cycle",0)&&$(".cycle").addClass("random"),$(".cycle").bind("click",function(){var e=$(this);e.hasClass("cycle1")?(e.removeClass("cycle1"),Settings.setValue("cycle",0),e.attr("title","顺序循环")):e.hasClass("random")?(e.removeClass("random").addClass("cycle1"),Settings.setValue("cycle",1),e.attr("title","单曲播放")):(e.addClass("random"),Settings.setValue("cycle",2),e.attr("title","随机播放"))}),$(".cd img").bind("error",function(){$(this).attr("src","img/cover.png")}),$(".list").on("click","a.fav",function(){e.subscribe($(this))}),$(".list").on("click",".author",function(){var a=$(this);a.attr("data-uid")&&(e.loaded.uid=a.attr("data-uid"),e.list("profile",1,40,!1,e.loaded.uid))}),$(".author").bind("click",function(){var a=$(this);a.attr("data-uid")&&(e.loaded.uid=a.attr("data-uid"),e.list("profile",1,40,!1,e.loaded.uid),$(".body").animate({top:0}),$(".footer").hide(),setTimeout(function(){$(".header").addClass("up"),$("nav div input").show()},300))}),$(".sider").bind("click",function(){$(".song").animate({marginLeft:"350"},200)}),$(".list").on("click",".memo",function(){var a=$(this).data("id"),t={title:$(this).data("title"),author:$(this).data("author"),face:$(this).data("face"),type:$(this).data("type")};e.songlist(a,t)}),$(".song").on("click",".s-play",function(){var a=$(this);e.player.playlist(a.data("id"),a.data("type"),0,a.data("index")),setTimeout(function(){$(".sider").trigger("click"),setTimeout(function(){$(".arrow").trigger("click")},200)},500)}),$(".lyric").click(function(){$(this).data("link")&&window.open($(this).data("link"))})},e.player={reset:function(){},playlist:function(e,t,i,l){t="play"+t;var s={act:t,data:Settings.getCacheValue(e),fav:i,idx:l};a.send(s)},up:function(){a.send({act:"up"})},down:function(){a.send({act:"down"})},play:function(){$(".ctrl").addClass("pause").removeClass("play"),$(".cd img").removeClass("pausing"),a.send({act:"play"})},pause:function(){e.loaded.playing=!0,a.send({act:"pause"}),$(".ctrl").removeClass("pause").addClass("play"),$(".cd img").addClass("pausing")},next:function(){a.send({act:"next"})},prev:function(){a.send({act:"prev"})},timing:function(a){var t=Math.ceil(a.time),i=Math.ceil(a.duration-a.time);$(".timer").text(tool.formatTime(i)),e.options&&1==e.options.lyric&&null!=e.lyric&&void 0!=e.lyric[t]&&$(".lyric").html(e.lyric[t])},info:function(){var a=Settings.getObject("song");a&&(a.isfaved?$("#favBtn").addClass("faved"):$("#favBtn").removeClass("faved"),$(".info,.lyric").html("&lt;"+a.name+"&gt;&nbsp;&nbsp;"+a.artists[0].name),e.options&&"album"==e.options.cover?$(".cd img").attr("src",a.album.picUrl):$(".cd img").attr("src",a.artists[0].picUrl),a.lyric?e.lyric=a.lyric:e.getLyric(a),$(".lyric").data("link","http://music.163.com/#/song?id="+a.id));var t=Settings.getObject("list");if(t){var i=t.coverUrl||t.coverImgUrl;$(".cover img").attr("src",i+"?param=60y60"),$(".title h1").text(t.name);var l=t.dj||t.creator;$(".title h2 a").text(l.nickname),$(".face a img").attr("src",l.avatarUrl),$(".title h2 a").attr("data-uid",l.userId)}var s=Settings.getObject("songs");s&&(e.loaded.songCount=s.length)}},e.list=function(a,t,i,l,s){if(l=l||!1,e.loaded.list&&!l&&e.loaded.listType==a&&"profile"!=a&&"search"!=a)return $(".list ul").hide(),void $(".list .collection").show();e.loading();var n=((new Date).getTime(),"全部");n=encodeURIComponent(n);var r="",o={};switch(t=20*(t-1),a){case"user":var c=e.loaded.userInfo.userId;r=e.domain+"/api/user/playlist?uid="+c+"&wordwrap=7&offset="+t+"&total=true&limit="+i;break;case"profile":r=e.domain+"/api/user/playlist/?offset=0&limit=301&uid="+s;break;case"hot":r=e.domain+"/api/playlist/list?cat="+n+"&order="+a+"&offset="+t+"&total=true&limit="+i;break;case"new":r=e.domain+"/api/playlist/list?cat="+n+"&order="+a+"&offset="+t+"&total=true&limit="+i;break;case"search":r=e.domain+"/api/search/get/web?cmd=search",o.s=s,o.type=1e3,o.offset=0,o.limit=100,o.total="false";break;default:n=encodeURIComponent(a),r=e.domain+"/api/playlist/list?cat="+a+"&order=hot&offset="+t+"&total=true&limit="+i}r+="&csrf_token="+e.lckey;var d='<li>	<p class="p[i]"><a title="[name]" data-id="[id]" data-type="list" data-fav="[favst]"></a><img src="[cover]" /></p>	<i class="loc"></i>	<section class="intro">	<div class="face"><img src="[face]"/></div>	<div class="memo" title="点击查看歌单歌曲列表" data-type="list" data-id="[id]" data-title="[name]" data-author="[nick]" data-face="[face]">[desc]</div>	<div class="num">		<i class="author" title="点击查看用户所有歌单" data-uid="[creator]">[nick]</i><a title="[title]" class="fav[faved]" data-id="[id]">[fav]</a><a class="hits">[hits]</a>	</div>	</section>	</li>',p="",u=function(i){if(200==i.code){e.loaded.list=!0,e.loaded.listType=a,e.loaded.loadingMore=!1;var s=i.playlists,n=i;("user"==a||"profile"==a)&&(s=i.playlist,n=i),"search"==a&&(s=i.result.playlists,n=i),e.loaded.hasMore=i.more?!0:!1;for(var r=0;r<s.length;r++){var o=s[r];Settings.setCacheValue(o.id,o),(null==o.coverImgUrl||""==o.coverImgUrl)&&(o.coverImgUrl="img/cover.png"),(""==o.description||null==o.description)&&(o.description=o.name);var c=d.replace("[cover]",o.coverImgUrl+"?param=60y60"),u=parseInt((r+4)/4)+5*(t-1);c=c.replace("[i]",u),c=void 0==o.creator.avatarUrl?c.replace(/\[face\]/g,"img/logo.png"):c.replace(/\[face\]/g,o.creator.avatarUrl),c=c.replace(/\[nick\]/g,o.creator.nickname),c=c.replace("[creator]",o.creator.userId),c=c.replace("[desc]",o.description),c=c.replace(/\[name\]/g,o.name),c=c.replace("[hits]",o.playCount),c=c.replace("[fav]",o.subscribedCount),c=c.replace(/\[id\]/g,o.id),"user"==a?(c=c.replace("[faved]"," faved"),c=c.replace("[title]"," 取消收藏"),c=0==r?c.replace("[favst]","1"):c.replace("[favst]","0")):(c=c.replace("[favst]","0"),c=c.replace("[faved]",""),c=c.replace("[title]"," 收藏歌单")),p+=c}l?$(".list .collection").append(p):($(".list ul").hide(),$(".list .collection").html(p).show(),$(".list").scrollTop(0)),e.loading(!0)}else e.loaded.hasMore=!1};"search"!=a?$.getJSON(r,function(e){u(e)}):$.post(r,o,function(e){var a=JSON.parse(e);u(a)})},e.search=function(){$(".list ul").hide(),$(".list").scrollTop(0),$(".list .search").show()},e.dj=function(a,t,i){if(i=i||!1,e.loaded.list&&!i&&"dj"==e.loaded.listType)return $(".list ul").hide(),void $(".list .collection").show();e.loading(),a=20*(a-1);var l=e.domain+"/api/djprogram/list?type=hot&offset="+a+"&total=true&limit="+t;l+="&csrf_token="+e.lckey;var s='<li>	<p class="p[i]"><a title="[name]" data-id="[id]" data-type="dj"></a><img src="[cover]" /></p>	<i class="loc"></i>	<section class="intro">	<div class="face"><img src="[face]"/></div>	<div class="memo" data-type="dj" data-id="[id]" data-title="[name]" data-author="[nick]" data-face="[face]">[desc]</div>	<div class="num">		<i data-uid="[creator]">[nick]</i><a class="hits">[hits]</a>	</div>	</section>	</li>',n="";$.getJSON(l,function(t){if(200==t.code){e.loaded.list=!0,e.loaded.listType="dj",e.loaded.loadingMore=!1;var l=t.result;e.loaded.hasMore=t.more?!0:!1;for(var r=0;r<l.length;r++){var o=l[r];Settings.setCacheValue(o.id,o),(null==o.coverUrl||""==o.coverUrl)&&(o.coverUrl="img/cover.png"),(""==o.description||null==o.description)&&(o.description=o.name);var c=s.replace("[cover]",o.coverUrl+"?param=60y60"),d=parseInt((r+4)/4)+5*(a-1);c=c.replace("[i]",d),c=c.replace(/\[face\]/g,o.dj.avatarUrl),c=c.replace(/\[nick\]/g,o.dj.nickname),c=c.replace("[creator]",o.dj.userId),c=c.replace("[desc]",o.description),c=c.replace(/\[name\]/g,o.name),c=c.replace("[hits]",o.listenerCount),c=c.replace("[fav]",o.subscribedCount),c=c.replace(/\[id\]/g,o.id),n+=c}i?$(".list .collection").append(n):($(".list ul").hide(),$(".list .collection").html(n).show(),$(".list").scrollTop(0)),e.loading(!0)}else e.loaded.hasMore=!1})},e.rank=function(){$(".list ul").hide(),$(".list").scrollTop(0),$(".list .rank").show()},e.radio=function(){if(e.loaded.radio)return $(".list ul").hide(),void $(".list .radio").show();e.loading();var a=((new Date).getTime(),e.domain+"/api/djprogram/list?type=new&offset=0&total=true&limit=20");a+="&csrf_token="+e.lckey;var t='<li>	<p class="p[i]"><a data-id="[id]" data-type="radio"></a><img src="[cover]" /></p>	<em>[name]</em></li>',i="";$.get(a,function(a){if(a=$.parseJSON(a),200==a.code){e.loaded.radio=!0;for(var l=0;l<a.result.length;l++){var s=a.result[l];Settings.setCacheValue(s.id,s);var n=s.coverUrl+"?param=60y60",r=t.replace("[cover]",n);r=r.replace("[i]",parseInt((l+4)/4)),r=r.replace("[name]",s.name),r=r.replace("[id]",s.id),i+=r}$(".list ul").hide(),$(".list .radio").html(i).show(),e.loading(!0)}})},e.singer=function(a,t){if(void 0==t&&e.loaded.singer&&e.loaded.singerKey==a)return $(".list ul").hide(),void $(".list .singer").show();e.loading(),t=t||1;var i=(new Date).getTime(),l=e.domain+"/search-ajaxsearch-searchalbum?kw="+a+"&pi="+t+"&pz=100&_="+i+"&lckey="+e.lckey,s='<li[class]>	<p class="p[i]"><a data-id="[id]" data-type="[type]" title="[title]"></a><img src="[cover]" /></p>	<em>[name]</em></li>',n="";$.getJSON(l,function(t){if(0==t.dm_error){e.loaded.singer=!0,e.loaded.singerKey=a;var i=0;for(i=0;i<t.artists.length;i++){var l=t.artists[i];Settings.setCacheValue(l.id,l);var r=l.portrait;null==r&&(r="img/cover.png");var o=s.replace("[cover]",r);o=o.replace("[i]",parseInt((i+4)/4)),o=o.replace("[name]",l.name),o=o.replace("[title]",l.name+"歌手电台"),o=o.replace("[id]",l.id),o=o.replace("[type]","singer"),o=o.replace("[class]"," class='star'"),n+=o}$(".list ul").hide();var c=0;for(c=0;c<t.albums.length;c++){var l=t.albums[c];Settings.setCacheValue(l.id,l);var r=l.cover;null==r&&(r="img/cover.png");var o=s.replace("[cover]",r);o=o.replace("[i]",parseInt((c+i+4)/4)),o=o.replace("[name]",l.name),o=o.replace("[title]",l.name),o=o.replace("[id]",l.id),o=o.replace("[type]","album"),o=o.replace("[class]",""),n+=o}$(".list .singer").html(n).show(),$(".list").scrollTop(0),e.loading(!0)}})},e.getLyric=function(a){var t=a.id;$(".lyric").text("正在加载歌词");var i=e.domain+"/api/song/media?id="+t+"&version=0";i+="&csrf_token="+e.lckey,$.getJSON(i,function(t){if(200==t.code&&!t.nolyric){for(var i=t.lyric.split("\n"),l=/^((?:\[[\d.:]+?\])+?)([^\[\]]*)$/,s={},n=0,r=i.length;r>n;n+=1){var o,c=i[n].match(l);if(c){o=c[1].slice(1,-1).split("][");for(var d,p=0,u=o.length;u>p;p+=1)d=o[p].split(":"),s[60*Number(d[0])+Math.round(d[1])]=c[2]}}a.lyric=s,Settings.setObject("song",a),e.lyric=s,$(".lyric").text(a.name)}}),$(".lyric").html(a.name)},e.user=function(a,t){chrome.cookies.get({url:"http://music.163.com",name:"MUSIC_U"},function(i){if(null!=i){$(".login").fadeOut();var l="";$.get("http://music.163.com/user/home",function(t){var i=/var\sGUser={(.*)}/i;l="{"+t.match(i)[1]+"}",l=l.replace("userId",'"userId"'),l=l.replace("nickname",'"nickname"'),l=l.replace("avatarUrl",'"avatarUrl"'),l=l.replace("userType",'"userType"'),l=l.replace("birthday",'"birthday"');var s=$.parseJSON(l);Settings.setObject("userInfo",s),e.loaded.userInfo=s,a&&e.list("user",1,100),chrome.cookies.get({url:e.domain,name:"__csrf"},function(a){null!=a&&(e.lckey=a.value),Settings.setValue("lckey",e.lckey)})})}else t?e.loaded.userInfo=null:($(".login").fadeIn(),$(".login .close").unbind("click"),$(".login .close").bind("click",function(){$(".login").fadeOut()}))})},e.subscribe=function(a){if(null==e.loaded.userInfo)return void e.user();e.loading();var t=a.attr("data-id"),i=e.domain+"/api/playlist/subscribe/?id="+t;a.hasClass("faved")&&(i=e.domain+"/api/playlist/unsubscribe?pid="+t+"&id="+t),i+="&csrf_token="+e.lckey,$.get(i,function(t){200==t.code&&(a.hasClass("faved")?(e.loaded.list=!1,e.showtip("取消收藏成功")):e.showtip("收藏成功"),a.toggleClass("faved"),e.loading(!0))})},e.loading=function(a){a?($(".loading").fadeOut(),clearTimeout(e.loaded.loadingTimer)):$(".loading").fadeIn()},e.fav=function(){if(null==e.loaded.userInfo)return void e.user();var a="1",t=Settings.getObject("song"),i="add";$("#favBtn").hasClass("faved")?($("#favBtn").removeClass("faved"),i="del",a="0",e.showtip("取消收藏成功")):($("#favBtn").addClass("faved"),e.showtip("收藏成功"));var l=e.domain+"/api/user/playlist/?offset=0&limit=301&uid="+e.loaded.userInfo.userId;l+="&csrf_token="+e.lckey,$.getJSON(l,function(a){if(200==a.code){for(var l="",s=0;s<a.playlist.length;s++){var n=a.playlist[s];if(!n.subscribed){l=n.id;break}}if(""!=l){var r=e.domain+"/api/playlist/manipulate/tracks",o={pid:l,op:i,trackIds:"["+t.id+"]",csrf_token:e.lckey};$.post(r,o,function(){})}}});for(var s=Settings.getObject("songs"),n=0;n<s.length;n++)s[n].isfaved=a,t.isfaved=a,Settings.setObject("song",t),Settings.setObject("songs",s)},e.hotkey=function(){var a=null,t=function(e){$(".tips").fadeIn().text(e),clearTimeout(a),a=setTimeout(function(){$(".tips").fadeOut()},1e3)};e.showtip=t,$("body").bind("keydown",function(){var a=window.event.keyCode;switch(a){case 39:e.player.reset(),e.player.next(),t("下一首");break;case 37:e.player.reset(),e.player.prev(),t("上一首");break;case 38:e.player.up();var i=100*Settings.getValue("volume",1);t("音量"+i+"%");break;case 40:e.player.down();var i=100*Settings.getValue("volume",1);t("音量"+i+"%");break;case 80:$(".cd .ctrl").hasClass("play")?(e.player.play(),t("播放")):(e.player.pause(),t("暂停"))}})},e.songlist=function(a,t){var i=e.domain+"/playlist?id="+a;"dj"==t.type&&(i=e.domain+"/dj?id="+a),$(".s-title").text(t.title),$(".s-pic").attr("title",t.author),$(".s-pic img").attr("src",t.face),$(".s-list").html('<p style="margin-left: 98px;margin-top: 80px;"><img src="img/loading.gif"></p>'),$(".song").animate({marginLeft:"0"},200),$.get(i,function(e){var i=/<table\sid="m-song-module"\sclass="m-table">([\s\S]*)<\/table>/;if(!i.test(e))return void $(".s-list").html('<p style="text-align:center;margin-top: 80px;">无歌曲列表~</p>');var l=e.match(i)[1],s=document.createElement("table");s.innerHTML=l;var n={ids:[],names:[],singers:[]},r=$(s);r.find(".ztag").each(function(){n.ids.push($(this).data("id"))}),r.find(".txt b a").each(function(){n.names.push($(this).text())}),r.find(".text span").each(function(){n.singers.push($(this).text())});for(var o=[],c=0;c<n.ids.length;c++)o.push('<li><span class="s-btn"><a class="s-play" data-index="'+c+'" data-type="'+t.type+'" data-id="'+a+'"></a><a class="s-index">'+(c+1)+'</a></span>				<a class="s-name" title="'+n.names[c]+'">'+n.names[c]+'</a><a class="s-singer" title="'+n.singers[c]+'">'+n.singers[c]+"</a></li>");$(".s-list").html(o.join(""))})},e.init(),e.hotkey(),window.netease=e});